


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ClaimController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">no.fint.betaling.claim</a>
</div>

<h1>Coverage Summary for Class: ClaimController (no.fint.betaling.claim)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ClaimController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/42)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package no.fint.betaling.claim;
&nbsp;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import no.fint.betaling.model.Claim;
&nbsp;import no.fint.betaling.model.ClaimStatus;
&nbsp;import no.fint.betaling.model.ClaimsDatePeriod;
&nbsp;import no.fint.betaling.model.Order;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;import org.springframework.web.server.ResponseStatusException;
&nbsp;import reactor.core.publisher.Flux;
&nbsp;import reactor.core.publisher.Mono;
&nbsp;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RestController
&nbsp;@RequestMapping(value = &quot;/claim&quot;)
&nbsp;public class ClaimController {
&nbsp;
&nbsp;    private final ClaimDatabaseService claimDatabaseService;
&nbsp;
&nbsp;    private final ClaimRestService claimRestService;
&nbsp;
&nbsp;    private final ScheduleService scheduleService;
&nbsp;    private final ClaimRestStatusService claimRestStatusService;
&nbsp;
<b class="nc">&nbsp;    public ClaimController(ClaimDatabaseService claimDatabaseService, ClaimRestService claimRestService, ScheduleService scheduleService, ClaimRestStatusService claimRestStatusService) {</b>
<b class="nc">&nbsp;        this.claimDatabaseService = claimDatabaseService;</b>
<b class="nc">&nbsp;        this.claimRestService = claimRestService;</b>
<b class="nc">&nbsp;        this.scheduleService = scheduleService;</b>
<b class="nc">&nbsp;        this.claimRestStatusService = claimRestStatusService;</b>
&nbsp;    }
&nbsp;
&nbsp;    @PostMapping
&nbsp;    public ResponseEntity&lt;List&lt;Claim&gt;&gt; storeClaim(@RequestBody Order order) {
<b class="nc">&nbsp;        log.info(&quot;Received order: {}&quot;, order);</b>
<b class="nc">&nbsp;        return ResponseEntity.status(HttpStatus.CREATED).body(claimDatabaseService.storeClaims(order));</b>
&nbsp;    }
&nbsp;
&nbsp;    @PostMapping(&quot;/send&quot;)
&nbsp;    public ResponseEntity&lt;Flux&lt;Claim&gt;&gt; sendClaims(@RequestBody List&lt;Long&gt; orderNumbers) {
<b class="nc">&nbsp;        log.info(&quot;Send claims for order number: {}&quot;, orderNumbers);</b>
<b class="nc">&nbsp;        Flux&lt;Claim&gt; flux = claimRestService.sendClaims(orderNumbers);</b>
&nbsp;
&nbsp;        // TODO: 02/05/2023 CT-688 Denne nullsjekken bør være undøvendig. Trolig årsak til at det ikke fungerer:
<b class="nc">&nbsp;        if (flux == null) {</b>
<b class="nc">&nbsp;            log.warn(&quot;In sendClaims, flux is null&quot;);</b>
<b class="nc">&nbsp;            flux = Flux.empty();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return ResponseEntity.status(HttpStatus.CREATED)</b>
<b class="nc">&nbsp;                .body(flux</b>
<b class="nc">&nbsp;                        .doOnNext(claim -&gt; log.info(&quot;Sent claim: orderNumber: {} Status: {} CreatedDate: {}&quot;, claim.getOrderNumber(), claim.getClaimStatus(), claim.getCreatedDate()))</b>
<b class="nc">&nbsp;                        .switchIfEmpty(Flux.empty())</b>
<b class="nc">&nbsp;                        .onErrorMap(throwable -&gt; {</b>
<b class="nc">&nbsp;                            log.error(&quot;Error occurred while sending claims&quot;, throwable);</b>
<b class="nc">&nbsp;                            return new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, &quot;Error occurred while sending claims&quot;, throwable);</b>
&nbsp;                        })
&nbsp;                );
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping
&nbsp;    public ResponseEntity&lt;List&lt;Claim&gt;&gt; getAllClaims(@RequestParam(required = false) String periodSelection,
&nbsp;                                                    @RequestParam(required = false) String schoolSelection,
&nbsp;                                                    @RequestParam(required = false) String[] status) {
&nbsp;
<b class="nc">&nbsp;        List&lt;Claim&gt; claims = claimDatabaseService.getClaimsByPeriodAndOrganisationnumberAndStatus(</b>
<b class="nc">&nbsp;                toDatePeriod(periodSelection), schoolSelection, toClaimStatus(status));</b>
&nbsp;
<b class="nc">&nbsp;        claimRestStatusService.setStatusMessages(claims);</b>
&nbsp;
<b class="nc">&nbsp;        return ResponseEntity.ok(claims);</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(&quot;/name/{name}&quot;)
&nbsp;    public ResponseEntity&lt;List&lt;Claim&gt;&gt; getClaimsByCustomerName(@PathVariable String name) {
<b class="nc">&nbsp;        return ResponseEntity.ok(claimDatabaseService.getClaimsByCustomerName(name));</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(&quot;/order-number/{order-number}&quot;)
&nbsp;    public ResponseEntity&lt;Claim&gt; getClaimsByOrderNumber(@PathVariable(value = &quot;order-number&quot;) long orderNumber) {
<b class="nc">&nbsp;        return ResponseEntity.ok(claimDatabaseService.getClaimByOrderNumber(orderNumber));</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(&quot;/status/{status}&quot;)
&nbsp;    public ResponseEntity&lt;List&lt;Claim&gt;&gt; getClaimsByStatus(@PathVariable String[] status) {
<b class="nc">&nbsp;        return ResponseEntity.ok(claimDatabaseService.getClaimsByStatus(toClaimStatus(status)));</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(&quot;/count/status/{status}&quot;)
&nbsp;    public ResponseEntity&lt;Integer&gt; getCountByStatus(@PathVariable String[] status,
&nbsp;                                                    @RequestParam(required = false) String days) {
<b class="nc">&nbsp;        return ResponseEntity.ok(claimDatabaseService.countClaimsByStatus(toClaimStatus(status), days));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @deprecated &lt;p&gt;This endpoint is being replaced by /count/status/{status}&lt;/p&gt;
&nbsp;     */
&nbsp;    @Deprecated
&nbsp;    @GetMapping(&quot;/count/by-status/{status}&quot;)
&nbsp;    public ResponseEntity&lt;Integer&gt; getCountByStatusOld(@PathVariable String[] status,
&nbsp;                                                       @RequestParam(required = false) String days) {
<b class="nc">&nbsp;        return ResponseEntity.ok(claimDatabaseService.countClaimsByStatus(toClaimStatus(status), days));</b>
&nbsp;    }
&nbsp;
&nbsp;    @DeleteMapping(&quot;/order-number/{order-number}&quot;)
&nbsp;    public ResponseEntity cancelClaimsByID(@PathVariable(&quot;order-number&quot;) long orderNumber) {
<b class="nc">&nbsp;        claimDatabaseService.cancelClaim(orderNumber);</b>
<b class="nc">&nbsp;        return ResponseEntity.noContent().build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(&quot;/update/all&quot;)
&nbsp;    public void updateAll() {
<b class="nc">&nbsp;        scheduleService.updateAcceptedClaims();</b>
<b class="nc">&nbsp;        scheduleService.updateIssuedClaims();</b>
<b class="nc">&nbsp;        scheduleService.updateUpdateErrorClaims();</b>
&nbsp;    }
&nbsp;
&nbsp;    @PostMapping((&quot;update/status&quot;))
&nbsp;    public Mono&lt;ResponseEntity&lt;Void&gt;&gt; updateClaimsStatus(@RequestParam(required = false) String periodSelection,
&nbsp;                                                         @RequestParam(required = false) String schoolSelection,
&nbsp;                                                         @RequestParam(required = false) String[] status) {
&nbsp;
<b class="nc">&nbsp;        return claimRestService</b>
<b class="nc">&nbsp;                .updateClaimsForPeriodAndOrganisation(toDatePeriod(periodSelection), schoolSelection, toClaimStatus(status))</b>
<b class="nc">&nbsp;                .then(Mono.just(new ResponseEntity&lt;Void&gt;(HttpStatus.OK)));</b>
&nbsp;    }
&nbsp;
&nbsp;    private ClaimStatus[] toClaimStatus(String[] status) {
<b class="nc">&nbsp;        if (status != null &amp;&amp; status.length &gt; 0) {</b>
<b class="nc">&nbsp;            return Arrays.stream(status).map(ClaimStatus::valueOf).toArray(ClaimStatus[]::new);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private ClaimsDatePeriod toDatePeriod(String periodSelection) {
<b class="nc">&nbsp;        if (StringUtils.isBlank(periodSelection)) periodSelection = ClaimsDatePeriod.ALL.name();</b>
<b class="nc">&nbsp;        return ClaimsDatePeriod.valueOf(periodSelection);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-08-12 08:44</div>
</div>
</body>
</html>
